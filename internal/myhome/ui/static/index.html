<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>MyHome Devices</title>
  <link rel="stylesheet" href="/static/bulma.min.css"/>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üè†</text></svg>"/>
  <script defer src="/static/alpine.min.js"></script>
  <script src="/static/htmx.min.js"></script>
  <style>
    .door-icon {
      display: inline-block;
      width: 16px;
      height: 16px;
      vertical-align: middle;
      margin-right: 4px;
    }
    .button.is-loading svg {
      opacity: 0.5;
    }
    [x-cloak] { display: none !important; }
  </style>
</head>
<body x-data="app()" @open-setup-modal.window="openSetupModal($event.detail)" @open-heater-modal.window="openHeaterModal($event.detail)" @edit-room.window="editRoom($event.detail)" @delete-room.window="confirmDeleteRoom($event.detail)">
  
  <!-- Hero Section -->
  <section class="hero is-light is-small">
    <div class="hero-body">
      <div class="container">
        <div class="level">
          <div class="level-left">
            <h1 class="title is-3">MyHome</h1>
            <span class="subtitle is-6 ml-3" x-text="`${deviceCount} devices / {{.Version}}`"></span>
          </div>
          <div class="level-right">
            <a class="button is-info" href="https://control.shelly.cloud" target="_blank" rel="noopener noreferrer">Shelly Control</a>
            <a class="button is-link ml-2" href="https://community.shelly.cloud/" target="_blank" rel="noopener noreferrer">Community Forum</a>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Devices Section -->
  <section class="section">
    <div class="container">
      <div class="columns is-multiline" 
           id="devices-container"
           hx-get="/htmx/devices"
           hx-trigger="load"
           hx-swap="innerHTML"
           hx-indicator="#loading-devices">
        <div id="loading-devices" class="column is-12 has-text-centered htmx-indicator">
          <p class="is-size-5">Loading devices...</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Rooms Management Section -->
  <section class="section pt-0">
    <div class="container">
      <div class="level">
        <div class="level-left">
          <h2 class="title is-4">üè† Rooms</h2>
        </div>
        <div class="level-right">
          <button class="button is-primary is-small" @click="showAddRoomModal()">+ Add Room</button>
        </div>
      </div>
      <div id="rooms-list" 
           class="columns is-multiline"
           hx-get="/htmx/rooms"
           hx-trigger="load, roomsUpdated from:body"
           hx-swap="innerHTML">
        <div class="column is-12">
          <p class="has-text-grey">Loading rooms...</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Room Edit Modal -->
  <div class="modal" :class="{'is-active': modals.room}">
    <div class="modal-background" @click="closeRoomModal()"></div>
    <div class="modal-card" style="max-width: 500px;">
      <header class="modal-card-head">
        <p class="modal-card-title" x-text="roomEditMode === 'create' ? 'Add Room' : 'Edit Room'"></p>
        <button class="delete" aria-label="close" @click="closeRoomModal()"></button>
      </header>
      <section class="modal-card-body">
        <div class="field">
          <label class="label">Room ID</label>
          <div class="control">
            <input class="input" type="text" x-model="roomForm.id" placeholder="e.g., living-room" :disabled="roomEditMode === 'edit'">
          </div>
          <p class="help">Unique identifier (lowercase, hyphens only)</p>
        </div>
        <div class="field">
          <label class="label">Room Name</label>
          <div class="control">
            <input class="input" type="text" x-model="roomForm.name" placeholder="e.g., Living Room">
          </div>
        </div>
        <div class="field">
          <label class="label">Room Types</label>
          <div class="control">
            <template x-for="kind in ['bedroom', 'office', 'living-room', 'kitchen', 'other']" :key="kind">
              <label class="checkbox mr-3">
                <input type="checkbox" :value="kind" x-model="roomForm.kinds">
                <span x-text="kind.charAt(0).toUpperCase() + kind.slice(1).replace('-', ' ')"></span>
              </label>
            </template>
          </div>
        </div>
        <hr>
        <p class="has-text-weight-semibold mb-2">Temperature Levels (¬∞C)</p>
        <div class="columns">
          <div class="column">
            <div class="field">
              <label class="label is-small">Eco</label>
              <input class="input is-small" type="number" x-model.number="roomForm.levels.eco" step="0.5">
            </div>
          </div>
          <div class="column">
            <div class="field">
              <label class="label is-small">Comfort</label>
              <input class="input is-small" type="number" x-model.number="roomForm.levels.comfort" step="0.5">
            </div>
          </div>
          <div class="column">
            <div class="field">
              <label class="label is-small">Away</label>
              <input class="input is-small" type="number" x-model.number="roomForm.levels.away" step="0.5">
            </div>
          </div>
        </div>
      </section>
      <footer class="modal-card-foot">
        <button class="button is-success" @click="submitRoomEdit()" :disabled="roomForm.saving">
          <span x-text="roomForm.saving ? 'Saving...' : 'Save'"></span>
        </button>
        <button class="button" @click="closeRoomModal()">Cancel</button>
        <button class="button is-danger is-outlined ml-auto" 
                @click="deleteRoom()" 
                x-show="roomEditMode === 'edit'">Delete</button>
      </footer>
    </div>
  </div>

  <!-- Setup Modal -->
  <div class="modal" :class="{'is-active': modals.setup}">
    <div class="modal-background" @click="closeSetupModal()"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        <p class="modal-card-title">Setup Device</p>
        <button class="delete" aria-label="close" @click="closeSetupModal()"></button>
      </header>
      <section class="modal-card-body">
        <div class="field">
          <label class="label">Device Name</label>
          <div class="control">
            <input class="input" type="text" x-model="setupForm.name" placeholder="Leave empty for auto-derivation">
          </div>
          <p class="help">Overrides automatic name derivation from output/input names</p>
        </div>
        <div class="field">
          <label class="label">Room</label>
          <div class="control">
            <div class="select is-fullwidth">
              <select x-model="setupForm.roomId">
                <option value="">-- No room --</option>
                <template x-for="room in rooms" :key="room.id">
                  <option :value="room.id" x-text="room.name || room.id"></option>
                </template>
              </select>
            </div>
          </div>
          <p class="help">Assign this device to a room for sensor auto-discovery</p>
        </div>
        <div class="field">
          <label class="label">MQTT Broker</label>
          <div class="control">
            <input class="input" type="text" x-model="setupForm.mqttBroker" placeholder="Leave empty for default">
          </div>
          <p class="help">e.g., 192.168.1.100:1883 or mqtt.local</p>
        </div>
        <hr>
        <p class="has-text-weight-semibold mb-2">WiFi Settings (optional)</p>
        <div class="field">
          <label class="label">STA ESSID</label>
          <div class="control">
            <input class="input" type="text" x-model="setupForm.staEssid" placeholder="Primary WiFi network name">
          </div>
        </div>
        <div class="field">
          <label class="label">STA Password</label>
          <div class="control">
            <input class="input" type="password" x-model="setupForm.staPasswd" placeholder="Primary WiFi password">
          </div>
        </div>
        <div class="field">
          <label class="label">STA1 ESSID</label>
          <div class="control">
            <input class="input" type="text" x-model="setupForm.sta1Essid" placeholder="Backup WiFi network name">
          </div>
        </div>
        <div class="field">
          <label class="label">STA1 Password</label>
          <div class="control">
            <input class="input" type="password" x-model="setupForm.sta1Passwd" placeholder="Backup WiFi password">
          </div>
        </div>
        <div class="field">
          <label class="label">AP Password</label>
          <div class="control">
            <input class="input" type="password" x-model="setupForm.apPasswd" placeholder="Access Point password">
          </div>
        </div>
      </section>
      <footer class="modal-card-foot">
        <button class="button is-success" @click="submitSetup()" :disabled="setupForm.saving">
          <span x-text="setupForm.saving ? 'Setting up...' : 'Setup'"></span>
        </button>
        <button class="button" @click="closeSetupModal()">Cancel</button>
      </footer>
    </div>
  </div>

  <!-- Heater Configuration Modal (simplified for demo) -->
  <div class="modal" :class="{'is-active': modals.heater}">
    <div class="modal-background" @click="closeHeaterModal()"></div>
    <div class="modal-card" style="max-width: 600px;">
      <header class="modal-card-head">
        <p class="modal-card-title">üî• Heater Configuration</p>
        <button class="delete" aria-label="close" @click="closeHeaterModal()"></button>
      </header>
      <section class="modal-card-body">
        <p class="notification is-info">Heater configuration UI would go here. This is a simplified demo.</p>
        <p>Device ID: <strong x-text="heaterForm.deviceId"></strong></p>
      </section>
      <footer class="modal-card-foot">
        <button class="button is-success" @click="closeHeaterModal()">Close</button>
      </footer>
    </div>
  </div>

  <footer class="footer">
    <div class="content has-text-centered has-text-grey-light is-size-7">
      Served by MyHome reverse proxy ¬∑ Powered by Alpine.js & HTMX
    </div>
  </footer>

  <script>
    function app() {
      return {
        deviceCount: 0,
        sensors: {},
        doors: {},
        switches: {},
        rooms: [],
        modals: {
          room: false,
          setup: false,
          heater: false
        },
        roomEditMode: 'create',
        roomForm: {
          id: '',
          name: '',
          kinds: ['other'],
          levels: { eco: 18, comfort: 20, away: 15 },
          saving: false
        },
        setupForm: {
          deviceId: '',
          name: '',
          roomId: '',
          mqttBroker: '',
          staEssid: '',
          staPasswd: '',
          sta1Essid: '',
          sta1Passwd: '',
          apPasswd: '',
          saving: false
        },
        heaterForm: {
          deviceId: ''
        },

        init() {
          this.connectSSE();
          this.loadRooms();
          
          // Debug HTMX events
          document.body.addEventListener('htmx:beforeRequest', (event) => {
            console.log('HTMX: beforeRequest', event.detail);
          });
          
          document.body.addEventListener('htmx:afterRequest', (event) => {
            console.log('HTMX: afterRequest', event.detail);
          });
          
          document.body.addEventListener('htmx:responseError', (event) => {
            console.error('HTMX: responseError', event.detail);
          });
          
          // Update device count after HTMX loads devices
          document.body.addEventListener('htmx:afterSwap', (event) => {
            console.log('HTMX: afterSwap', event.detail);
            if (event.detail.target.id === 'devices-container') {
              const deviceCards = document.querySelectorAll('#devices-container .card');
              this.deviceCount = deviceCards.length;
              console.log('Device count updated:', this.deviceCount);
              
              // Reinitialize Alpine.js for the new content
              if (window.Alpine) {
                window.Alpine.initTree(event.detail.target);
              }
            }
          });
        },

        async toggleSwitch(deviceId, switchId) {
          const btn = document.getElementById('btn-switch-' + deviceId + '-' + switchId);
          const shape = document.getElementById('btn-switch-' + deviceId + '-' + switchId + '-shape');
          
          if (btn) {
            btn.disabled = true;
            btn.classList.add('is-loading');
          }
          
          try {
            const res = await fetch('/rpc', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ 
                method: 'switch.toggle', 
                params: {
                  identifier: deviceId,
                  switch_id: parseInt(switchId)
                }
              })
            });
            
            if (!res.ok) {
              console.error('toggleSwitch: error', await res.text());
              return;
            }
            
            const out = await res.json();
            const newState = !out.result.result.was_on;
            
            if (btn) {
              btn.disabled = false;
              btn.classList.remove('is-loading');
              
              if (newState) {
                btn.classList.remove('is-light');
                btn.classList.add('is-info', 'is-active');
                shape.innerHTML = `
                  <rect x="1" y="5" width="22" height="14" rx="7" ry="7"></rect>
                  <circle cx="16" cy="12" r="3"></circle>
                `;
              } else {
                btn.classList.remove('is-info', 'is-active');
                btn.classList.add('is-light');
                shape.innerHTML = `
                  <rect x="1" y="5" width="22" height="14" rx="7" ry="7"></rect>
                  <circle cx="8" cy="12" r="3"></circle>
                `;
              }
            }
          } catch (e) {
            console.error('toggleSwitch: error', e);
            if (btn) {
              btn.disabled = false;
              btn.classList.remove('is-loading');
            }
          }
        },

        async refreshDevice(deviceId) {
          const btn = document.getElementById('btn-refresh-' + deviceId);
          if (btn) {
            btn.disabled = true;
            btn.classList.add('is-loading');
          }
          
          try {
            console.log('refreshDevice: POST /rpc device.refresh for', deviceId);
            const res = await fetch('/rpc', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ method: 'device.refresh', params: deviceId })
            });
            
            console.log('refreshDevice: response status', res.status);
            if (!res.ok) {
              console.error('refreshDevice: error', await res.text());
              return;
            }
            
            console.log('refreshDevice: success');
          } catch (e) {
            console.error('refreshDevice: error', e.name, e.message, e);
          } finally {
            if (btn) {
              btn.disabled = false;
              btn.classList.remove('is-loading');
            }
          }
        },

        connectSSE() {
          const eventSource = new EventSource('/events');
          
          eventSource.addEventListener('connected', () => {
            console.log('SSE: connected');
          });

          eventSource.addEventListener('sensor-update', (e) => {
            try {
              const data = JSON.parse(e.data);
              this.updateSensor(data.device_id, data.sensor, data.value);
            } catch (err) {
              console.error('SSE: Failed to parse sensor-update:', err);
            }
          });

          eventSource.addEventListener('device-update', (e) => {
            try {
              const deviceView = JSON.parse(e.data);
              console.log('SSE: device-update', deviceView);
              this.updateDeviceView(deviceView);
            } catch (err) {
              console.error('SSE: Failed to parse device-update:', err);
            }
          });

          eventSource.onerror = (e) => {
            console.error('SSE: error:', e);
          };
        },

        updateSensor(deviceId, sensor, value) {
          if (!this.sensors[deviceId]) {
            this.sensors[deviceId] = {};
          }
          
          if (sensor === 'temperature') {
            this.sensors[deviceId].temperature = value + '¬∞C';
          } else if (sensor === 'humidity') {
            this.sensors[deviceId].humidity = value + '%';
          } else if (sensor === 'window') {
            this.doors[deviceId] = value === "0" ? 'open' : 'closed';
          }
        },

        updateDeviceView(deviceView) {
          if (!deviceView || !deviceView.id) {
            console.error('Invalid device update: missing id', deviceView);
            return;
          }

          const deviceId = deviceView.id;

          // Update switches if present
          if (deviceView.switches) {
            for (const [switchId, switchData] of Object.entries(deviceView.switches)) {
              const btn = document.getElementById('btn-switch-' + deviceId + '-' + switchId);
              const shape = document.getElementById('btn-switch-' + deviceId + '-' + switchId + '-shape');
              
              if (btn && shape) {
                const isOn = switchData.on || false;
                
                if (isOn) {
                  btn.classList.remove('is-light');
                  btn.classList.add('is-info', 'is-active');
                  shape.innerHTML = `
                    <rect x="1" y="5" width="22" height="14" rx="7" ry="7"></rect>
                    <circle cx="16" cy="12" r="3"></circle>
                  `;
                } else {
                  btn.classList.remove('is-info', 'is-active');
                  btn.classList.add('is-light');
                  shape.innerHTML = `
                    <rect x="1" y="5" width="22" height="14" rx="7" ry="7"></rect>
                    <circle cx="8" cy="12" r="3"></circle>
                  `;
                }
              }
            }
          }

          // Update sensors if present
          if (deviceView.temperature !== undefined && deviceView.temperature !== null) {
            if (!this.sensors[deviceId]) this.sensors[deviceId] = {};
            this.sensors[deviceId].temperature = deviceView.temperature.toFixed(1) + '¬∞C';
          }
          if (deviceView.humidity !== undefined && deviceView.humidity !== null) {
            if (!this.sensors[deviceId]) this.sensors[deviceId] = {};
            this.sensors[deviceId].humidity = deviceView.humidity.toFixed(1) + '%';
          }

          // Update door sensor if present
          if (deviceView.door_opened !== undefined && deviceView.door_opened !== null) {
            this.doors[deviceId] = deviceView.door_opened ? 'open' : 'closed';
          }
        },

        getDoorClass(deviceId) {
          const state = this.doors[deviceId];
          if (state === 'open') return 'is-warning';
          if (state === 'closed') return 'is-success';
          return 'is-light';
        },

        getDoorText(deviceId) {
          const state = this.doors[deviceId];
          if (state === 'open') return 'Open';
          if (state === 'closed') return 'Closed';
          return 'Unknown';
        },

        getDoorPath(deviceId) {
          const state = this.doors[deviceId];
          if (state === 'open') {
            return 'M3 21V3h12l6 6v12H3zm2-2h14V9.828L14.172 5H5v14zm9-6h2v2h-2v-2z';
          }
          return 'M3 21V3h12v18H3zm2-2h8V5H5v14zm9-6h2v2h-2v-2z';
        },

        async loadRooms() {
          try {
            const res = await fetch('/rpc', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ method: 'room.list', params: null })
            });
            if (res.ok) {
              const data = await res.json();
              if (data.result && data.result.rooms) {
                this.rooms = data.result.rooms;
              }
            }
          } catch (e) {
            console.error('Failed to load rooms:', e);
          }
        },

        showAddRoomModal() {
          this.roomEditMode = 'create';
          this.roomForm = {
            id: '',
            name: '',
            kinds: ['other'],
            levels: { eco: 18, comfort: 20, away: 15 },
            saving: false
          };
          this.modals.room = true;
        },

        async editRoom({roomId}) {
          try {
            const res = await fetch('/rpc', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ method: 'temperature.get', params: { room_id: roomId } })
            });
            if (!res.ok) {
              alert('Failed to load room');
              return;
            }
            const data = await res.json();
            const room = data.result || data;

            this.roomEditMode = 'edit';
            this.roomForm = {
              id: roomId,
              name: room.name || '',
              kinds: room.kinds || ['other'],
              levels: room.levels || { eco: 18, comfort: 20, away: 15 },
              saving: false
            };
            this.modals.room = true;
          } catch (e) {
            alert('Error loading room: ' + e);
          }
        },

        closeRoomModal() {
          this.modals.room = false;
        },

        async submitRoomEdit() {
          this.roomForm.saving = true;
          try {
            const method = this.roomEditMode === 'create' ? 'room.create' : 'room.edit';
            const params = {
              id: this.roomForm.id,
              name: this.roomForm.name || this.roomForm.id,
              kinds: this.roomForm.kinds,
              levels: this.roomForm.levels
            };

            const res = await fetch('/rpc', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ method, params })
            });

            if (!res.ok) {
              const t = await res.text();
              alert('Failed to save room: ' + t);
              return;
            }

            if (this.roomEditMode === 'create') {
              await fetch('/rpc', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                  method: 'temperature.set', 
                  params: { 
                    room_id: this.roomForm.id, 
                    name: this.roomForm.name || this.roomForm.id, 
                    kinds: this.roomForm.kinds, 
                    levels: this.roomForm.levels 
                  } 
                })
              });
            }

            this.closeRoomModal();
            this.loadRooms();
            document.body.dispatchEvent(new CustomEvent('roomsUpdated'));
          } catch (e) {
            alert('Error: ' + e);
          } finally {
            this.roomForm.saving = false;
          }
        },

        async deleteRoom() {
          if (!confirm('Delete this room?\n\nNote: If this room is assigned to heaters, they will need to be reconfigured.')) {
            return;
          }
          try {
            const res = await fetch('/rpc', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ method: 'room.delete', params: { id: this.roomForm.id } })
            });
            if (!res.ok) {
              const t = await res.text();
              alert('Failed to delete room: ' + t);
              return;
            }
            this.closeRoomModal();
            this.loadRooms();
            document.body.dispatchEvent(new CustomEvent('roomsUpdated'));
          } catch (e) {
            alert('Error deleting room: ' + e);
          }
        },

        confirmDeleteRoom({roomId, roomName}) {
          if (confirm(`Delete room "${roomName}"?\n\nNote: If this room is assigned to heaters, they will need to be reconfigured.`)) {
            this.deleteRoomById(roomId);
          }
        },

        async deleteRoomById(roomId) {
          try {
            const res = await fetch('/rpc', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ method: 'room.delete', params: { id: roomId } })
            });
            if (!res.ok) {
              const t = await res.text();
              alert('Failed to delete room: ' + t);
              return;
            }
            this.loadRooms();
            document.body.dispatchEvent(new CustomEvent('roomsUpdated'));
          } catch (e) {
            alert('Error deleting room: ' + e);
          }
        },

        async openSetupModal({deviceId}) {
          this.setupForm = {
            deviceId,
            name: '',
            roomId: '',
            mqttBroker: '',
            staEssid: '',
            staPasswd: '',
            sta1Essid: '',
            sta1Passwd: '',
            apPasswd: '',
            saving: false
          };
          
          await this.loadRooms();
          
          try {
            const res = await fetch('/rpc', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ method: 'device.show', params: { identifier: deviceId } })
            });
            if (res.ok) {
              const data = await res.json();
              if (data.result) {
                this.setupForm.roomId = data.result.room_id || '';
                this.setupForm.name = data.result.name || '';
              }
            }
          } catch (e) {
            console.log('Could not fetch device info:', e);
          }
          
          this.modals.setup = true;
        },

        closeSetupModal() {
          this.modals.setup = false;
        },

        async submitSetup() {
          this.setupForm.saving = true;
          try {
            const params = { identifier: this.setupForm.deviceId };
            
            if (this.setupForm.name) params.name = this.setupForm.name;
            if (this.setupForm.mqttBroker) params.mqtt_broker = this.setupForm.mqttBroker;
            if (this.setupForm.staEssid) params.sta_essid = this.setupForm.staEssid;
            if (this.setupForm.staPasswd) params.sta_passwd = this.setupForm.staPasswd;
            if (this.setupForm.sta1Essid) params.sta1_essid = this.setupForm.sta1Essid;
            if (this.setupForm.sta1Passwd) params.sta1_passwd = this.setupForm.sta1Passwd;
            if (this.setupForm.apPasswd) params.ap_passwd = this.setupForm.apPasswd;

            if (this.setupForm.roomId !== undefined) {
              await fetch('/rpc', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                  method: 'device.setroom', 
                  params: { identifier: this.setupForm.deviceId, room_id: this.setupForm.roomId } 
                })
              });
            }

            const res = await fetch('/rpc', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ method: 'device.setup', params })
            });
            
            if (!res.ok) {
              const t = await res.text();
              alert('Setup failed: ' + t);
              return;
            }
            
            this.closeSetupModal();
            setTimeout(() => location.reload(), 500);
          } catch (e) {
            alert('Setup error: ' + e);
          } finally {
            this.setupForm.saving = false;
          }
        },

        openHeaterModal({deviceId}) {
          this.heaterForm.deviceId = deviceId;
          this.modals.heater = true;
        },

        closeHeaterModal() {
          this.modals.heater = false;
        }
      };
    }
  </script>
</body>
</html>
